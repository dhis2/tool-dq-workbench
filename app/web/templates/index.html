{% extends "layout.html" %}

{% block content %}
<h1>Data Quality Monitor</h1>

<h2>Server Config</h2>
<table class="table table-sm table-bordered w-auto">
    <tbody>
    {% for key, value in config.server.items() %}
    {% if key != 'd2_token' %}
    <tr>
        <th>{{ key }}</th>
        <td>{{ value }}</td>
    </tr>
    {% endif %}
    {% endfor %}
    </tbody>
</table>
<a class="btn btn-outline-secondary mb-3" href="{{ url_for('api.edit_server') }}">Edit Server Config</a>

<h2>Stages</h2>
<table class="table table-sm align-middle">
  <thead>
    <tr>
      <th>Stage Name</th>
      <th>Type</th>
      <th class="text-end">Actions</th>
    </tr>
  </thead>
  <tbody>
    {% for stage in config.stages %}
      <tr>
        <td><strong>{{ stage.name }}</strong></td>
        <td><span class="badge bg-secondary text-uppercase">{{ stage.type }}</span></td>
        <td class="text-end">
          <form method="POST" class="run-stage-form d-inline" data-index="{{ loop.index0 }}">
            <button type="submit" class="btn btn-sm btn-outline-success me-1">Run</button>
          </form>

          {% if stage.type == 'outlier' %}
            <a href="{{ url_for('api.edit_outlier_stage', stage_index=loop.index0) }}" class="btn btn-sm btn-outline-primary me-1">Edit</a>
          {% elif stage.type == 'validation_rules' %}
            <a href="{{ url_for('api.edit_validation_rule_stage', stage_index=loop.index0) }}" class="btn btn-sm btn-outline-primary me-1">Edit</a>
          {% endif %}

          <form method="POST" action="{{ url_for('api.delete_stage', stage_index=loop.index0) }}" onsubmit="return confirm('Delete this stage?');" class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
          </form>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>


<a href="{{ url_for('api.new_outlier_stage') }}" class="btn btn-success mb-3">+ New Outlier Stage</a>
<a href="{{ url_for('api.new_validation_rule_stage') }}" class="btn btn-success mb-3">+ New Validation Rule Stage</a>

<form id="runForm" action="{{ url_for('api.run') }}" method="post">
    <button id="runButton" class="btn btn-primary" type="submit">
        <span id="spinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"
              style="display: none;"></span>
        Run All
    </button>
</form>

<div id="run-summary" class="mt-3"></div>

{% include "partials/_run_controls.html" %}
{% endblock %}
