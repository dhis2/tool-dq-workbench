{% extends "layout.html" %}

{% block title %}{{ 'Edit' if edit else 'Create' }} Outlier Stage{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='tomselect/tom-select.bootstrap5.min.css') }}">
  <script src="{{ url_for('static', filename='tomselect/tom-select.complete.js') }}"></script>
  {% include "partials/tom_select_dataelement.html" %}
  {% include "partials/tom_select_dataset.html" %}
{% endblock %}

{% block content %}
  {% include "partials/_flashes.html" %}
  <h1>{{ 'Edit' if edit else 'Create' }} Outlier Stage</h1>

  <form method="post">
    <div class="mb-3">
      <label class="form-label" for="stage_name">Stage Name</label>
      <input class="form-control" id="stage_name" name="stage_name" value="{{ stage.name or '' }}" required>
    </div>

    <div class="mb-3">
      <label class="form-label" for="orgunit_level">Org Unit Level</label>
      <input class="form-control" id="orgunit_level" name="orgunit_level" type="number" value="{{ stage.level or 1 }}" required>
    </div>

    <div class="mb-3">
      <label class="form-label" for="duration">Duration (e.g. 12 months)</label>
      <input class="form-control" id="duration" name="duration" value="{{ stage.duration or '12 months' }}" required>
    </div>

    <div class="mb-3">
      <label class="form-label" for="dataset">Dataset</label>
      <select id="dataset" name="dataset" class="form-select">
        {% if stage.params.dataset %}
          <option value="{{ stage.params.dataset }}" selected>
            {{ ds_name or stage.params.dataset }}
          </option>
        {% endif %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label" for="algorithm">Algorithm</label>
      <select class="form-select" id="algorithm" name="algorithm">
        {% for alg in ['MOD_Z_SCORE', 'MIN_MAX', 'Z_SCORE', 'INVALID_NUMERIC'] %}
          <option value="{{ alg }}" {% if stage.params.algorithm == alg %}selected{% endif %}>{{ alg }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="mb-3">
      <label class="form-label" for="threshold">Threshold</label>
      <input class="form-control" id="threshold" name="threshold" type="number" value="{{ stage.params.threshold or 3 }}" required>
    </div>

    <div class="mb-3">
      <label class="form-label" for="destination_data_element">Destination Data Element</label>
      <select id="destination_data_element" name="destination_data_element" class="form-select">
        {% if stage.params.destination_data_element %}
          <option value="{{ stage.params.destination_data_element }}" selected>
            {{ data_element_name or stage.params.destination_data_element }}
          </option>
        {% endif %}
      </select>
    </div>

    <div class="mb-3 form-check">
      <input class="form-check-input" type="checkbox" id="active" name="active" {% if stage.active %}checked{% endif %}>
      <label class="form-check-label" for="active">Active</label>
    </div>

    <button class="btn btn-primary" type="submit">{{ 'Update' if edit else 'Create' }} Stage</button>
    <a class="btn btn-secondary" href="{{ url_for('ui.index') }}">Cancel</a>
  </form>
{% endblock %}

