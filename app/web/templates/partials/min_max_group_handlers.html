<script>
(function () {
  const groupsDiv = document.getElementById('groups');
  const addBtn = document.getElementById('addGroup');

  // Helper: show/hide constant fields
  function toggleConstantFields(groupEl) {
    if (!groupEl) return;
    const select = groupEl.querySelector('select[id$="-method"]');
    const constant = groupEl.querySelector('.constant-fields');
    if (!select || !constant) return;
    const isConstant = (select.value || '').toUpperCase() === 'CONSTANT';
    constant.classList.toggle('d-none', !isConstant);
  }

  // New group button handler
  addBtn.addEventListener('click', function () {
    const index = groupsDiv.querySelectorAll('.group-entry').length;
    const newGroup = document.createElement('div');
    newGroup.className = 'mb-3 border rounded p-2 mb-2 group-entry';
    newGroup.innerHTML = `
      <label class="form-label" for="groups-${index}-limitMedian">Limit Median</label>
      <input class="form-control" id="groups-${index}-limitMedian" name="groups-${index}-limitMedian" type="number" required>

      <label class="form-label mt-2" for="groups-${index}-method">Method</label>
      <select class="form-select" id="groups-${index}-method" name="groups-${index}-method" required>
        <option value="PREV_MAX">PREV_MAX</option>
        <option value="BOXCOX">BOXCOX</option>
        <option value="CONSTANT">Constant values</option>
      </select>

      <label class="form-label mt-2" for="groups-${index}-threshold">Threshold</label>
      <input class="form-control" id="groups-${index}-threshold" name="groups-${index}-threshold" type="number" step="0.01" required>

      <div class="constant-fields mt-2 d-none">
        <label class="form-label" for="groups-${index}-constantMin">Constant Minimum</label>
        <input class="form-control" id="groups-${index}-constantMin" name="groups-${index}-constantMin" type="number" step="1">
        <label class="form-label mt-2" for="groups-${index}-constantMax">Constant Maximum</label>
        <input class="form-control" id="groups-${index}-constantMax" name="groups-${index}-constantMax" type="number" step="1">
      </div>

      <button type="button" class="btn btn-danger btn-sm mt-2 remove-group">Delete Group</button>
    `;
    groupsDiv.appendChild(newGroup);
    toggleConstantFields(newGroup); // set initial state
  });

  // Event delegation for toggles and deletes
  groupsDiv.addEventListener('change', function (e) {
    if (e.target.matches('select[id$="-method"]')) {
      toggleConstantFields(e.target.closest('.group-entry'));
    }
  });

  groupsDiv.addEventListener('click', function (e) {
    if (e.target.classList.contains('remove-group')) {
      const group = e.target.closest('.group-entry');
      if (group) group.remove();
    }
  });

  // Initialize all existing groups
  groupsDiv.querySelectorAll('.group-entry').forEach(toggleConstantFields);
})();
</script>