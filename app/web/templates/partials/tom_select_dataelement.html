<script>
  document.addEventListener("DOMContentLoaded", function () {
    const dataElementEl = document.getElementById("destination_data_element");
    if (!dataElementEl) return;

    const config = {
      valueField: "id",
      labelField: "text",
      searchField: "text",
      placeholder: "Type to search for data elements...",
      load: function(query, callback) {
        if (query.length < 3) return callback();
        fetch(`/api/data-elements?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(callback)
          .catch(() => callback());
      },
      preload: true,
      create: false,
    };

    {% if stage.params.destination_data_element %}
      config.options = [{
        id: "{{ stage.params.destination_data_element }}",
        text: "{{ data_element_name or stage.params.destination_data_element }}"
      }];
      config.items = ["{{ stage.params.destination_data_element }}"];
    {% else %}
      config.options = [];
      config.items = [];
    {% endif %}

    new TomSelect(dataElementEl, config);
  });
</script>
