<script>
  document.addEventListener("DOMContentLoaded", function () {
    const datasetEl = document.getElementById("dataset");
    if (!datasetEl) return;

    const config = {
      valueField: "id",
      labelField: "text",
      searchField: "text",
      placeholder: "Type to search for datasets...",
      load: function(query, callback) {
        if (query.length < 3) return callback();
        fetch(`/api/datasets?q=${encodeURIComponent(query)}`)
          .then(response => response.json())
          .then(callback)
          .catch(() => callback());
      },
      preload: true,
      create: false,
    };

    {% if stage.params and stage.params.dataset %}
      config.options = [{
        id: "{{ stage.params.dataset }}",
        text: "{{ dataset_name or stage.params.dataset }}"
      }];
      config.items = ["{{ stage.params.dataset }}"];
    {% else %}
      config.options = [];
      config.items = [];
    {% endif %}

    new TomSelect(datasetEl, config);
  });
</script>

