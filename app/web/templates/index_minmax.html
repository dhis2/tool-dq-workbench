{% extends "layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">Min-max generation</h1>
</div>

<!-- Buttons -->
<div class="mb-3">
    <a href="{{ url_for('api.new_minmax_stage') }}" class="btn btn-success btn-sm me-2">+ New Min-Max Stage</a>
</div>

<!-- Stage Table For min max generation stages-->
<h2 class="h5 mt-4">Stages</h2>
<table class="table table-sm align-middle">
    <thead>
    <tr>
        <th>Stage Name</th>
        <th class="text-end">Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for stage in config.min_max_stages %}
    <tr>
        <td><strong>{{ stage.name }}</strong></td>
        <td class="text-end">
            <form method="POST" action="{{ url_for('api.run_min_max_stage', stage_index=loop.index0) }}"
                  class="run-stage-form d-inline" data-index="{{ loop.index0 }}">
                <button type="submit" class="btn btn-sm btn-outline-success me-1">Run</button>
            </form>
            <a href="{{ url_for('api.edit_minmax_stage', stage_index=loop.index0) }}"
               class="btn btn-sm btn-outline-primary me-1">Edit</a>
            <form method="POST" action="{{ url_for('api.delete_minmax_stage', stage_index=loop.index0) }}"
                  onsubmit="return confirm('Delete this stage?');" class="d-inline">
                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>
<div id="run-summary" class="mt-3"></div>
<script>
    document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.run-stage-form').forEach(form => {
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const stageIndex = form.dataset.index;
            const runSummary = document.getElementById('run-summary');

            // Clear previous summary
            runSummary.innerHTML = 'Running...';

            try {
                const response = await fetch(`/api/run-min-max-stage/${stageIndex}`, {
                    method: 'POST',
                });

                const responseText = await response.text(); // Read response as text
                try {
                    const result = JSON.parse(responseText); // Parse JSON
                    if (result.success) {
                        runSummary.innerHTML = `
                            <strong>Run Summary:</strong><br>
                            Outliers detected: ${result["Outliers detected"]}<br>
                            Value errors: ${result["Value errors"]}<br>
                            Values ignored: ${result["Values ignored"]}<br>
                            Values imported: ${result["Values imported"]}<br>
                            Values missing: ${result["Values missing"]}<br>
                            Duration: ${result["Duration"]}<br>
                        `;
                    } else {
                        runSummary.innerHTML = `Error: ${result.errors.join(', ')}`;
                    }
                } catch (jsonError) {
                    console.error('Failed to parse JSON:', responseText);
                    runSummary.innerHTML = `Error: Unexpected response format.`;
                }
            } catch (error) {
                runSummary.innerHTML = `Error: ${error.message}`;
            }
        });
    });
});
</script>
<!-- Run summary -->

{% include "partials/_run_controls.html" %}
{% endblock %}